{% extends "accounts/account_view/account_view_base.html" %}
{% load static %}

{% block navigation %}
    <a href="{% url 'accounts:account_view' user_details.userid %}">Profile</a>/
    <a href="{% url 'accounts:account_analytics' user_details.userid %}">Analytics</a>/
{% endblock %}

{% block account_view_content %}
    <p>{{ user_details.userid }}</p>
    {% if request.user.is_student %}
        <div id="registered-course-graphs" style="width: 100%">
            {% if registered_courses %}
                <h2>Courses you are registered in</h2>
                <div id="registered-course-navbar" class="navbar">
                    {% for course in registered_courses %}
                        <p data-value="{{ course.id }}"
                           data-function="updateRegisteredGraphs">{{ course.title }}</p>
                    {% endfor %}
                </div>
                <pre id="registered-response-pre" class="response-text"></pre>

                <div class="container-numbers"></div>
                <div class="container-graphs"></div>
            {% else %}
                <h2>You are currently not registered for any courses</h2>
            {% endif %}
        </div>
    {% endif %}
    {% if request.user.is_staff %}
        <div id="owned-course-graphs" style="width: 100%">
            {% if owned_courses %}
                <h2>Courses you own</h2>
                <div id="owned-course-navbar" class="navbar">
                    {% for course in owned_courses %}
                        <p data-value="{{ course.id }}"
                           data-function="updateOwnedGraphs">{{ course.title }}</p>
                    {% endfor %}
                </div>
                <pre id="owned-response-pre" class="response-text"></pre>

                <div class="container-numbers"></div>
                <div class="container-graphs"></div>
            {% else %}
                <h2>You currently own no courses</h2>
            {% endif %}
        </div>
        <div id="course-assignment-graphs" style="width: 100%">
            {% if owned_courses %}
                <h3 id="assignment-header">Course [] Modules</h3>
                <div id="course-assignment-navbars" style="width: 100%"></div>
                <pre id="assignment-response-pre" class="response-text"></pre>

                <div class="container-numbers"></div>
                <div class="container-graphs"></div>
            {% endif %}
        </div>
    {% endif %}
{% endblock %}
{% block extrajavascript %}
    <script src={% static 'js/graphs.js' %}></script>
    <script>
        function setStudentAssignmentMarks(data) {
            setToGraph(
                document.getElementById('container-student-assignment-marks'),
                data,
                'assignment marks',
                'bar',
                {
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    suggestedMin: 0,
                                    suggestedMax: 100
                                }
                            }]
                        }
                    }
                }
            );
        }

        function setCourseProgress(data) {
            setToGraph(
                document.getElementById('container-course-progress'),
                data,
                'course progress',
                'pie',
                {
                    options: {

                        scales: {
                            yAxes: [{
                                display: false
                            }],
                            xAxes: [{
                                display: false
                            }]
                        }
                    }
                }
            );
        }
        function setModuleProgress(modules) {
            let moduleProgress = document.getElementById('module-progress');
            for (let module in modules) {
                let moduleContainer = document.createElement('div');
                moduleContainer.className = 'graph-container';
                moduleContainer.style.maxWidth = '400px';
                moduleContainer.style.float = 'left';
                moduleProgress.appendChild(moduleContainer)
                setToGraph(
                    moduleContainer,
                    modules[module]['data'],
                    modules[module]['name'],
                    'pie',
                    {
                        options: {
                            legend: {
                                display: false
                            },
                            scales: {
                                yAxes: [{
                                    display: false
                                }],
                                xAxes: [{
                                    display: false
                                }]
                            }
                        }
                    }
                )
            }
        }
        function setAverageScores(data) {
            setToGraph(
                document.getElementById('container-average-score'),
                data,
                'average student score',
                'bar',
                {
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    suggestedMin: 0,
                                    suggestedMax: 100
                                }
                            }]
                        }
                    }
                }
            );
        }
        function setAverageTime(data) {
            setToGraph(
                document.getElementById('container-average-time'),
                data,
                'average time taken',
                'bar'
            )
        }
        function setOverallAssignmentMarks(data) {
            setToGraph(
                document.getElementById('container-assignment-marks'),
                data,
                'student marks',
                'bar',
                {
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    suggestedMin: 0,
                                    suggestedMax: 100
                                }
                            }]
                        }
                    }
                }
            )
        }
        function setAssignmentTime(data) {
            setToGraph(
                document.getElementById('container-assignment-time'),
                data,
                'time taken',
                'bar'
            )
        }

        function addGraphs(container, graphData) {
            for (let graph of graphData) {
                // Put graphs with the same container id in the same div
                let graphContainer = $('#' + graph.container_id);
                if (!graphContainer.length) {
                    graphContainer = $('<div>').attr('id', graph.container_id)
                        .addClass('graph-container').addClass(graph.type);
                    container.append(graphContainer);
                }
                setToGraph(
                    graphContainer[0],
                    graph
                );
            }
        }

        function addStats(container, numberData) {
            for (let stat of numberData) {
                let numbersContainer = $('#' + stat.container_id);
                if (!numbersContainer.length) {
                    numbersContainer = $('<div>').attr('id', stat.container_id)
                        .addClass('numbers-container')
                    container.append(numbersContainer);
                }
                numbersContainer.append(
                    $('<p>').text(stat.name + ":" + stat.value)
                )
            }
        }

        /**
         * Empty all child elements containing graphs
         * @param parent Parent element to empty
         */
        function clearGraphs(parent) {
            parent.find('.graph-container').each(function(index, element) {
                $(element).html('');
            });
            parent.find('.numbers-container').find('.numbers-value').each(function (index, element) {
                $(element).html('');
            });
        }

        /**
         * Query then set registered course graph data for the given course
         * @param course Course id to query data for
         */
        function updateRegisteredGraphs(course) {
            standardAjaxCall(
                '/account/registeredCourseAnalyticsAjax',
                {
                    "account": "{{ user_details.userid }}",
                    "course": course
                },
                function (response) {
                    // Clear any existing response text
                    standardSuccessResponse('', $('#registered-response-pre'));
                    let registeredCourse = $('#registered-course-graphs')
                    let graphsContainer = registeredCourse.find('.container-graphs');
                    let numbersContainer = registeredCourse.find('.container-numbers');
                    graphsContainer.html();

                    if (response.number_data !== undefined)
                        addStats(numbersContainer, response.number_data);
                    if (response.graphs !== undefined)
                        addGraphs(graphsContainer, response.graphs)
                },
                function (response) {
                    standardErrorResponse(response, $('#registered-response-pre'));
                }
            );
        }

        /**
         * Query then set owned course graph data for the given course
         * @param course Course id to query data for
         */
        function updateOwnedGraphs(course) {
            standardAjaxCall(
                '/account/ownedCourseAnalyticsAjax',
                {
                    "account": "{{ user_details.userid }}",
                    "course": course
                },
                function (response) {
                    // Clear any existing response text
                    standardSuccessResponse('', $('#owned-response-pre'));
                    $('#assignment-header').text('Course [' + response.title + '] Modules');

                    let registeredCourse = $('#owned-course-graphs')
                    let graphsContainer = registeredCourse.find('.container-graphs');
                    let numbersContainer = registeredCourse.find('.container-numbers');
                    graphsContainer.html();

                    if (response.number_data !== undefined)
                        addStats(numbersContainer, response.number_data);
                    if (response.graphs !== undefined)
                        addGraphs(graphsContainer, response.graphs)

                    if (response.modules !== undefined) {
                        let navbarContainer = $('#course-assignment-navbars');
                        navbarContainer.html('');
                        for (let module in response.modules) {
                            navbarContainer.append($('<h4>').text(response.modules[module].name));
                            let navbar = $('<div>').addClass('navbar').addClass('navbar-no-auto');
                            navbarContainer.append(navbar);
                            for (let assignment of response.modules[module].assignments) {
                                navbar.append($('<p>')
                                    .attr('data-value', assignment.id)
                                    .attr('data-function', 'updateCourseAssignmentGraphs')
                                    .text(assignment.label));
                            }
                            updateNavbar(navbar);
                        }
                    }
                },
                function (response) {
                    standardErrorResponse(response, $('#owned-response-pre'));
                }
            );
        }
        function updateCourseAssignmentGraphs(assignment) {
            standardAjaxCall(
                '/account/courseAssignmentAnalyticsAjax',
                {
                    "account": "{{ user_details.userid }}",
                    "assignment": assignment
                },
                function (response) {
                    standardSuccessResponse('', $('assignment-response-pre'));

                    let registeredCourse = $('#course-assignment-graphs')
                    let graphsContainer = registeredCourse.find('.container-graphs');
                    let numbersContainer = registeredCourse.find('.container-numbers');
                    graphsContainer.html();

                    if (response.number_data !== undefined)
                        addStats(numbersContainer, response.number_data);
                    if (response.graphs !== undefined)
                        addGraphs(graphsContainer, response.graphs)
                },
                function (response) {
                    standardErrorResponse(response, $('#assignment-response-pre'));
                }
            )
        }
    </script>
{% endblock %}
