{% extends "base.html" %}
{% load course %}

{% block title %}
    {% if object %}
        Edit content "{{ object.title }}"
    {% else %}
        Add new content
    {% endif %}
{% endblock %}
{% block content %}
    {% with course=module.course %}
        <h1>
            {{ course.title }}
        </h1>
        <div class="container-fluid">
            <div class="row">
                <div class="col-12 col-md-3">
                    <div class="contents">
                        <h3>Modules</h3>
                        <ul id="modules">
                            {% for m in course.modules.all %}
                                <li data-id="{{ m.id }}"{% if m == module %}
                                    class="selected"{% endif %}>
                                    <a href="{% url "courses:module_list" m.id %}">
                                    <span>
                                        Module<span class="order">
                                        {{ m.order|add:1 }}
                                    </span>
                                    </span>
                                        <br>
                                        {{ m.title }}
                                    </a>
                                </li>
                            {% empty %}
                                <li>No modules yet</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-12 col-md-9">

                    <div class="module">
                        <form id="form-container" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            {{ question_formset.management_form }}
                            {% for form in question_formset %}
                                <div class="question_formset">
                                    {{ form.as_p }}
                                </div>

                                {% for f in choices_formset %}
                                    <div class="choices_formset">
                                        {{ f.as_p }}
                                    </div>
                                {% endfor %}
                            {% endfor %}

                            <button id="add-choices-form" type="button">Add Choice</button>

                            <button id="add-form" type="button">Add Question</button>
                            <button type="submit">Save Questions</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endwith %}
    <script>
        let questionForm = document.querySelectorAll(".question_formset")
        let choicesForm = document.querySelectorAll(".choices_formset")
        let container = document.querySelector("#form-container")
        let addButton = document.querySelector("#add-form")
        let addButtonChoices = document.querySelector("#add-choices-form")
        let totalForms = document.querySelector("#id_form-TOTAL_FORMS")
        let totalChoicesForm = document.querySelector("#id_choices-TOTAL_FORMS")


        let formNum = questionForm.length - 1
        let choicesFormNum = choicesForm.length - 1
        addButton.addEventListener('click', addForm)
        addButtonChoices.addEventListener('click', addChoicesForm)

        function addForm(e) {
            e.preventDefault()

            let newForm = questionForm[0].cloneNode(true)
            let formRegex = RegExp(`form-(\\d){1}-`, 'g')

            formNum++
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, `form-${formNum}-`)
            container.insertBefore(newForm, addButton)
            container.insertBefore(addButtonChoices, addButton)

            totalForms.setAttribute('value', `${formNum + 1}`)
        }

        function addChoicesForm(e) {
            e.preventDefault()

            let newForm = choicesForm[0].cloneNode(true)
            let formRegex = RegExp(`choices-(\\d){1}-`, 'g')

            choicesFormNum++
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, `choices-${formNum}-${choicesFormNum}-`)
            container.insertBefore(newForm, addButtonChoices)

            totalChoicesForm.setAttribute('value', `${choicesFormNum + 1}`)
        }
    </script>
{% endblock %}
